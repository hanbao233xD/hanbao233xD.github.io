!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Pjax=e()}(this,(function(){"use strict";function t(t,e,o){return t instanceof HTMLCollection||t instanceof NodeList||t instanceof Array?Array.prototype.forEach.call(t,e,o):e.call(o,t,0,[t])}const e=(t,e)=>{(t="string"==typeof t?t.split(" "):t).forEach(e)};function o(o,s,n,i){e(s,(e=>{t(o,(t=>{t.addEventListener(e,n,i)}))}))}function s(o,s,n={}){e(s,(e=>{const s=new CustomEvent(e,{bubbles:!0,cancelable:!0,...n});t(o,(t=>{t.dispatchEvent(s)}))}))}function n(t){const e=t.text||t.textContent||t.innerHTML||"",o=t.src||"",s=t.parentNode||document.querySelector("head")||document.documentElement,n=document.createElement("script");return!e.match("document.write")&&(n.type="text/javascript",n.id=t.id,""!==o&&(n.src=o,n.async=!1),""!==e&&n.appendChild(document.createTextNode(e)),s.appendChild(n),(s instanceof HTMLHeadElement||s instanceof HTMLBodyElement)&&s.contains(n)&&s.removeChild(n),!0)}function i(e,o,s,n=document){e.forEach((e=>{t(n.querySelectorAll(e),o,s)}))}var r=(()=>{let t=0;return()=>`pjax${(new Date).getTime()}_${t++}`})();function l(t,e){t.outerHTML=e.outerHTML,this.onSwitch()}function c(t,e){if(t.innerHTML=e.innerHTML,e.hasAttributes()){const o=e.attributes;for(let e=0;e<o.length;e++)t.attributes.setNamedItem(o[e].cloneNode())}this.onSwitch()}const a="data-pjax-state";function h(t,e){if(e.defaultPrevented||!1===e.returnValue)return;const o={...this.options},s=function(t,e){if(e.which>1||e.metaKey||e.ctrlKey||e.shiftKey||e.altKey)return"modifier";if(t.protocol!==window.location.protocol||t.host!==window.location.host)return"external";if(t.hash&&t.href.replace(t.hash,"")===window.location.href.replace(location.hash,""))return"anchor";if(t.href===window.location.href.split("#")[0]+"#")return"anchor-empty";return null}(t,e);if(s)t.setAttribute(a,s);else{if(e.preventDefault(),this.options.currentUrlFullReload&&t.href===window.location.href.split("#")[0])return t.setAttribute(a,"reload"),void this.reload();t.setAttribute(a,"load"),o.triggerElement=t,this.loadUrl(t.href,o)}}function u(t){if("a"!==t.tagName.toLowerCase())throw new Error("theme-shokax-pjax can only be applied on <a>");t.hasAttribute("data-pjax-state")||this.attachLink(t)}function d(e,o,s,n,i,r){const c=[];s.forEach((s=>{const a=n.querySelectorAll(s),h=i.querySelectorAll(s);if(a.length!==h.length)throw new Error(`DOM doesn't look the same on new loaded page: '${s}' - new ${a.length}, old ${h.length}`);t(a,((t,n)=>{const i=h[n],a=e[s]?e[s].bind(this,i,t,r,o[s]):l.bind(this,i,t,r);c.push(a)}),this)}),this),this.state.numPendingSwitches=c.length,c.forEach((t=>{t()}))}class p{constructor(t){this.state={numPendingSwitches:0,href:null,options:null},this.options=function({elements:t="a[href]",selectors:e=["title",".js-Pjax"],switches:o={},switchesOptions:s={},history:n=!0,scrollTo:i=0,scrollRestoration:r=!0,cacheBust:l=!0,timeout:a=0,currentUrlFullReload:h=!1}={}){const u={elements:t,selectors:e,switches:o,switchesOptions:s,history:n,scrollTo:i,scrollRestoration:r,cacheBust:l,timeout:a,currentUrlFullReload:h};return u.switches.head||(u.switches.head=c),u.switches.body||(u.switches.body=c),u}(t),this.options.scrollRestoration&&"scrollRestoration"in history&&(history.scrollRestoration="manual"),this.maxUid=this.lastUid=r(),this.parseDOM(document),o(window,"popstate",(t=>{const e=t;if(e.state){const t={...this.options};t.url=e.state.url,t.title=e.state.title,t.history=!1,t.scrollPos=e.state.scrollPos,e.state.uid<this.lastUid?t.backward=!0:t.forward=!0,this.lastUid=e.state.uid,this.loadUrl(e.state.url,t)}}))}getElements(t){return t.querySelectorAll(this.options.elements)}parseDOM(e){t(this.getElements(e),u,this)}refresh(t){this.parseDOM(t||document)}reload(){window.location.reload()}forEachSelectors(t,e,o){return i.bind(this)(this.options.selectors,t,e,o)}switchSelectors(t,e,o,s){return d.bind(this)(this.options.switches,this.options.switchesOptions,t,e,o,s)}latestChance(t){window.location=t}onSwitch(){s(window,"resize scroll"),this.state.numPendingSwitches--,0===this.state.numPendingSwitches&&this.afterAllSwitches()}loadContent(t,e){if("string"!=typeof t)return void s(document,"pjax:complete pjax:error",e);const o=document.implementation.createHTMLDocument("pjax"),n=/\s?[a-z:]+(?:=['"][^'">]+['"])*/gi;let i=t.match(/<html[^>]+>/gi);if(i&&i.length&&(i=i[0].match(n),i.length&&(i.shift(),i.forEach((t=>{const e=t.trim().split("=");1===e.length?o.documentElement.setAttribute(e[0],"true"):o.documentElement.setAttribute(e[0],e[1].slice(1,-1))})))),o.documentElement.innerHTML=t,document.activeElement&&function(t,e,o){for(const s of e){const e=t.querySelectorAll(s);for(let t=0;t<e.length;t++)if(e[t].contains(o))return!0}return!1}(document,this.options.selectors,document.activeElement))try{document.activeElement.blur()}catch(t){}this.switchSelectors(this.options.selectors,o,document,e)}loadUrl(t,e){e="object"==typeof e?{...this.options,...e}:{...this.options},this.abortRequest(this.request),s(document,"pjax:send",e),this.request=this.doRequest(t,e,this.handleResponse.bind(this))}afterAllSwitches(){var e,o,i;this.options.selectors.forEach((e=>{t(document.querySelectorAll(e),(e=>{!function(e){"script"===e.tagName.toLowerCase()&&n(e),t(e.querySelectorAll("script"),(t=>{const e=t;e.type&&"text/javascript"!==e.type.toLowerCase()||(e.parentNode&&e.parentNode.removeChild(e),n(e))}))}(e)}))}));const l=this.state;if((null===(e=l.options)||void 0===e?void 0:e.history)&&(window.history.state||(this.lastUid=this.maxUid=r(),window.history.replaceState({url:window.location.href,title:document.title,uid:this.maxUid,scrollPos:[0,0]},document.title)),this.lastUid=this.maxUid=r(),window.history.pushState({url:l.href,title:l.options.title,uid:this.maxUid,scrollPos:[0,0]},l.options.title,l.href)),this.forEachSelectors((t=>{this.parseDOM(t)}),this),s(document,"pjax:complete pjax:success",l.options),null===(o=l.options)||void 0===o?void 0:o.history){const t=document.createElement("a");if(t.href=this.state.href,t.hash){let e=t.hash.slice(1);e=decodeURIComponent(e);let o=0,s=document.getElementById(e)||document.getElementsByName(e)[0];if(s&&s.offsetParent)do{o+=s.offsetTop,s=s.offsetParent}while(s);window.scrollTo(0,o)}else!1!==l.options.scrollTo&&(Array.isArray(l.options.scrollTo)?window.scrollTo(l.options.scrollTo[0],l.options.scrollTo[1]):window.scrollTo(0,l.options.scrollTo))}else(null===(i=l.options)||void 0===i?void 0:i.scrollRestoration)&&l.options.scrollPos&&window.scrollTo(l.options.scrollPos[0],l.options.scrollPos[1]);this.state={numPendingSwitches:0,href:null,options:null}}abortRequest(t){t&&t.readyState<4&&(t.onreadystatechange=()=>{},t.abort())}}return p.prototype.attachLink=function(t){t.setAttribute(a,""),o(t,"click",(e=>h.call(this,t,e))),o(t,"keyup",(e=>{const o=e;13===o.keyCode&&h.call(this,t,o)}))},p.prototype.doRequest=function(t,e={},o){const s=e.requestOptions||{},n=(s.requestMethod||"GET").toUpperCase(),i=s.requestParams||null;let r=null;const l=new XMLHttpRequest,c=e.timeout;if(l.onreadystatechange=()=>{4===l.readyState&&(200===l.status?o(l.responseText,l,t,e):0!==l.status&&o(null,l,t,e))},l.onerror=s=>{console.error(s),o(null,l,t,e)},l.ontimeout=()=>{o(null,l,t,e)},i&&i.length){let e=i.map((t=>t.name+"="+t.value)).join("&");switch(n){case"GET":t=t.split("?")[0],t+="?"+e;break;case"POST":r=e}}return e.cacheBust&&(t=function(t,e,o){const s=new RegExp("([?&])"+e+"=.*?(&|$)","i"),n=-1!==t.indexOf("?")?"&":"?";return t.match(s)?t.replace(s,"$1"+e+"="+o+"$2"):t+n+e+"="+o}(t,"t",Date.now())),l.open(n,t,!0),l.timeout=c,l.setRequestHeader("X-Requested-With","XMLHttpRequest"),l.setRequestHeader("X-PJAX","true"),l.setRequestHeader("X-PJAX-Selectors",JSON.stringify(e.selectors)),l.send(r),l},p.prototype.handleResponse=function(t,e,o,n){if((n={...n||this.options}).request=e,!1===t)return void s(document,"pjax:complete pjax:error",n);const i=window.history.state||{};window.history.replaceState({url:i.url||window.location.href,title:i.title||document.title,uid:i.uid||r(),scrollPos:[document.documentElement.scrollLeft||document.body.scrollLeft,document.documentElement.scrollTop||document.body.scrollTop]},document.title,window.location.href);const l=o;e.responseURL?o!==e.responseURL&&(o=e.responseURL):e.getResponseHeader("X-PJAX-URL")?o=e.getResponseHeader("X-PJAX-URL"):e.getResponseHeader("X-XHR-Redirected-To")&&(o=e.getResponseHeader("X-XHR-Redirected-To"));const c=document.createElement("a");c.href=l;const a=c.hash;c.href=o,a&&!c.hash&&(c.hash=a,o=c.href),this.state.href=o,this.state.options=n;try{this.loadContent(t,n)}catch(t){return s(document,"pjax:error",n),console.error("Pjax switch fail: ",t),this.latestChance(o)}},p.switches={innerHTML:function(t,e){t.innerHTML=e.innerHTML,""===e.className?t.removeAttribute("class"):t.className=e.className,this.onSwitch()},outerHTML:l},p}));
